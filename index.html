<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Konarak — Stall Audit (Premium)</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root{
  --bg1: linear-gradient(135deg,#eef2f3,#d9e4f5);
  --card:#ffffff;
  --muted:#6b7280;
  --accent:#0f172a;
  --gold:#d4af37;
  --glass: rgba(255,255,255,0.6);
  --shadow: 0 10px 30px rgba(2,6,23,0.12);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background: var(--bg1);
  color:#0b1220;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* Header & layout */
.header{
  height:64px;
  background:#0b1220;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 20px;
  position:sticky;
  top:0;
  z-index:40;
  box-shadow:0 6px 18px rgba(2,6,23,0.18);
}
.header .brand {display:flex;align-items:center;gap:12px;font-weight:700;font-size:18px}
.header .brand img{height:36px;width:36px;object-fit:contain;border-radius:6px;background:#fff;padding:3px}
.header .actions{display:flex;gap:8px;align-items:center}

/* container */
.container{max-width:1200px;margin:28px auto;padding:0 18px}

/* top area */
.top-row{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin-bottom:18px}
.location-card{
  background:var(--card);
  padding:14px;border-radius:12px;box-shadow:var(--shadow);
  display:flex;gap:12px;align-items:center;min-width:380px;
}
.location-card label{font-size:12px;color:var(--muted)}
.location-card input, .location-card select{
  padding:8px 10px;border-radius:8px;border:1px solid #e6eefc;background:#fbfdff;
  font-size:14px;min-width:140px;
}

/* buttons */
.btn{
  background:linear-gradient(180deg,#1f71ff,#165cff);
  color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 8px 20px rgba(22,92,255,0.18);
}
.btn.ghost{background:transparent;color:#0b1220;border:1px solid rgba(11,18,32,0.06);box-shadow:none}
.small{padding:8px 10px;font-size:13px}

/* question grid */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:18px;margin-top:18px;
}
.qcard{
  background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,255,0.9));
  border-radius:16px;padding:18px;box-shadow:0 12px 30px rgba(9,20,36,0.08);position:relative;overflow:hidden;
  transition:transform .22s ease, box-shadow .22s ease;
}
.qcard:hover{transform:translateY(-6px);box-shadow:0 18px 36px rgba(9,20,36,0.12)}
.qcard .title{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.qcard .title img{height:34px;width:34px;filter:drop-shadow(0 6px 18px rgba(0,0,0,0.08))}
.qcard .title .label{font-weight:700;font-size:16px;color:#07102a}
select.form-control{width:100%;padding:10px;border-radius:10px;border:1px solid #eef3fb;background:#fff;font-size:14px}
.qcard .note{font-size:12px;color:var(--muted);margin-top:8px}

/* bottom */
.bottom-row{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:22px;flex-wrap:wrap}
.summary-panel{display:flex;gap:12px;align-items:center;background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);}
.summary-item{text-align:center;padding:6px 10px}
.summary-item .num{font-weight:800;font-size:20px}
.rating-stars{display:flex;gap:6px;align-items:center}

/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(3,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:120}
.modal{background:linear-gradient(180deg,#fff,#fbfdff);padding:18px;border-radius:14px;max-width:940px;width:96%;box-shadow:0 25px 70px rgba(2,6,23,0.28)}
.card-variant{display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;border:1px solid #eef4ff;cursor:pointer}
.card-preview{flex:1;background:#f8fafc;padding:10px;border-radius:8px;display:flex;align-items:center;justify-content:center;height:120px}

/* render area */
#renderArea{position:fixed;left:-5000px;top:-5000px;pointer-events:none;z-index:9999}
.render-remarks{white-space:pre-wrap;word-wrap:break-word;line-height:1.35;font-size:16px;color:#334155}

/* responsive */
@media(max-width:900px){
  .location-card{min-width:unset;width:100%}
  .grid{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="brand">
    <img src="logo.png" id="topLogo" alt="Konarak logo" onerror="this.style.display='none'">
    Konarak Food & Beverages — Stall Audit
  </div>
  <div class="actions">
    <button id="btnExportImage" class="btn small">Download Rating Card Image</button>
    <button id="btnExportCSV" class="btn small ghost">Export CSV</button>
  </div>
</div>

<!-- MAIN -->
<div class="container">
  <div class="top-row">
    <div class="location-card">
      <div>
        <label>Building</label><br>
        <input id="building" placeholder="Enter building (e.g., SKYVIEW 1)">
      </div>
      <div>
        <label>Floor</label><br>
        <input id="floor" placeholder="Floor (e.g., G, 1, 2)">
      </div>
      <div>
        <label>Counter / Stall</label><br>
        <input id="counter" placeholder="Counter name (e.g., S2)">
      </div>
      <div>
        <label>Date</label><br>
        <input id="date" type="date">
      </div>
      <div style="margin-left:12px;display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <button id="btnReset" class="btn ghost small">Reset</button>
      </div>
    </div>
  </div>

  <!-- Questions -->
  <div class="grid" id="questionsGrid"></div>

  <!-- bottom -->
  <div class="bottom-row">
    <div class="summary-panel">
      <div style="padding-right:12px;border-right:1px dashed #eef3fb">
        <div style="font-size:12px;color:var(--muted)">Total Score (out of 120)</div>
        <div class="summary-item"><div class="num" id="totalScore">0</div></div>
      </div>
      <div style="padding-left:12px;border-left:1px dashed #eef3fb;margin-left:12px">
        <div style="font-size:12px;color:var(--muted)">Percentage</div>
        <div style="font-weight:800;font-size:18px" id="percentage">0%</div>
      </div>
      <div style="padding-left:12px;border-left:1px dashed #eef3fb;margin-left:12px">
        <div style="font-size:12px;color:var(--muted)">Rating (0-5)</div>
        <div class="rating-stars" id="ratingStars" style="padding-top:6px"></div>
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <select id="reportRange" style="padding:8px;border-radius:8px;border:1px solid #e6eefc">
        <option value="day">Daily</option>
        <option value="week">Weekly</option>
        <option value="month">Monthly</option>
      </select>
      <button id="btnDownload" class="btn small">Generate & Download Card</button>
    </div>
  </div>

  <!-- mini chart + actions -->
  <div style="display:flex;gap:18px;margin-top:18px;flex-wrap:wrap">
    <div style="flex:1;min-width:320px" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Recent Scores</strong>
        <small style="color:var(--muted)">Last 10</small>
      </div>
      <canvas id="miniChart" height="80"></canvas>
    </div>

    <div style="width:320px" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Actions</strong>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button id="btnSaveLocal" class="btn">Save Entry (Local)</button>
        <button id="btnLoadLocal" class="btn ghost">Load Entries</button>
        <button id="btnClearLocal" class="btn ghost">Clear Entries</button>
      </div>
    </div>
  </div>

  <!-- entries -->
  <div style="margin-top:20px" class="card">
    <strong>Saved Entries</strong>
    <div style="margin-top:12px">
      <table id="entriesTable" style="width:100%;border-collapse:collapse">
        <thead><tr style="text-align:left"><th>Date</th><th>Building</th><th>Floor</th><th>Counter</th><th>Score</th><th>Percentage</th><th>Rating</th><th>Actions</th></tr></thead>
        <tbody id="entriesBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Select Card Design (A / B / C)</h3>
    <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
      <div class="card-variant" data-variant="A" onclick="selectVariant('A')">
        <div class="card-preview" style="width:220px">
          <div style="text-align:center">
            <div style="font-weight:800;color:var(--gold);font-size:14px">Luxury Gold Certificate</div>
            <div style="margin-top:10px">HORIZONTAL</div>
          </div>
        </div>
        <div style="flex:1">
          <div class="variant-label">Variant A</div>
          <div style="color:var(--muted);font-size:13px">Gold certificate, landscape HD image.</div>
        </div>
      </div>

      <div class="card-variant" data-variant="B" onclick="selectVariant('B')">
        <div class="card-preview" style="width:220px">
          <div style="text-align:center">
            <div style="font-weight:800;color:#2563eb;font-size:14px">Modern ID Card</div>
            <div style="margin-top:10px">VERTICAL</div>
          </div>
        </div>
        <div style="flex:1">
          <div class="variant-label">Variant B</div>
          <div style="color:var(--muted);font-size:13px">Mobile-friendly vertical card.</div>
        </div>
      </div>

      <div class="card-variant" data-variant="C" onclick="selectVariant('C')">
        <div class="card-preview" style="width:220px">
          <div style="text-align:center">
            <div style="font-weight:800;color:#0b1220;font-size:14px">Minimal Premium</div>
            <div style="margin-top:10px">CLEAN</div>
          </div>
        </div>
        <div style="flex:1">
          <div class="variant-label">Variant C</div>
          <div style="color:var(--muted);font-size:13px">Minimal elegant card.</div>
        </div>
      </div>
    </div>

    <div style="margin-top:14px;text-align:right">
      <button onclick="closeModal()" class="btn small ghost">Cancel</button>
    </div>
  </div>
</div>

<!-- Hidden render area -->
<div id="renderArea" aria-hidden="true"></div>

<script>
/* ============================
   Data model: fields and questions
   ============================ */
const QUESTIONS = [
  { key: 'sales_report', text: 'Daily sales report submitted?' },
  { key: 'feedback_report', text: 'Daily feedback report submitted?' },
  { key: 'breakfast_on_time', text: 'Breakfast arranged on time (08:00)?' },
  { key: 'lunch_on_time', text: 'Lunch arranged on time (12:30)?' },
  { key: 'dinner_on_time', text: 'Dinner arranged on time (20:00)?' },
  { key: 'temp_photo', text: 'Food temperature measured & photo posted?' },
  { key: 'staff_behaviour', text: 'Staff behaviour is good?' },
  { key: 'staff_hygiene', text: 'Staff hygiene is good?' },
  { key: 'stall_clean', text: 'Stall is clean and hygienic?' },
  { key: 'food_complaint', text: 'Food quality complaints received?' , negative:true},
  { key: 'cbre_complaint', text: 'CBRE complaint received?' , negative:true},
  { key: 'cognizant_complaint', text: 'Cognizant complaint received?' , negative:true}
];
const STORAGE_KEY = "konarak_audit_entries_v1";

/* DOM refs */
const questionsGrid = document.getElementById('questionsGrid');
const totalScoreEl = document.getElementById('totalScore');
const percentageEl = document.getElementById('percentage');
const ratingStarsEl = document.getElementById('ratingStars');
const dateEl = document.getElementById('date');
const buildingEl = document.getElementById('building');
const floorEl = document.getElementById('floor');
const counterEl = document.getElementById('counter');

const btnSaveLocal = document.getElementById('btnSaveLocal') || document.getElementById('btnSaveLocal');
const btnLoadLocal = document.getElementById('btnLoadLocal') || document.getElementById('btnLoadLocal');
const btnClearLocal = document.getElementById('btnClearLocal') || document.getElementById('btnClearLocal');
const btnExportCSV = document.getElementById('btnExportCSV');
const btnExportImage = document.getElementById('btnExportImage');
const btnDownload = document.getElementById('btnDownload');
const btnReset = document.getElementById('btnReset');

const entriesBody = document.getElementById('entriesBody');
const reportRange = document.getElementById('reportRange');

let miniChart = null;

/* INIT */
function init(){
  // date default
  dateEl.value = new Date().toISOString().slice(0,10);
  renderQuestionCards();
  wireEvents();
  loadEntriesToUI();
  computeAndRenderScore();
  renderMiniChart();
}
init();

/* render question cards */
function renderQuestionCards(){
  QUESTIONS.forEach(q=>{
    const card = document.createElement('div');
    card.className = 'qcard';
    card.innerHTML = `
      <div class="title">
        <img src="https://img.icons8.com/fluency/48/000000/checklist.png" alt="" />
        <div class="label">${q.text}</div>
      </div>
      <div class="dropdown">
        <select class="form-control" data-key="${q.key}">
          <option>Yes</option>
          <option>No</option>
        </select>
      </div>
      <div class="note">${q.negative ? 'Note: complaint (Yes) reduces score.' : ''}</div>
    `;
    questionsGrid.appendChild(card);
  });

  document.querySelectorAll('.form-control').forEach(el=>{
    el.addEventListener('change', ()=> computeAndRenderScore());
  });
}

/* compute scoring: 12 questions × 10 = 120 total */
function computeAndRenderScore(){
  const values = {};
  QUESTIONS.forEach(q=>{
    const sel = document.querySelector(`select[data-key="${q.key}"]`);
    values[q.key] = sel ? sel.value : 'No';
  });

  // Each question 10 points.
  // For complaints (negative): No = 10, Yes = 0.
  let total = 0;
  QUESTIONS.forEach(q=>{
    const v = (values[q.key] || '').toUpperCase();
    if (q.negative){
      total += (v === 'NO' ? 10 : 0);
    } else {
      total += (v === 'YES' ? 10 : 0);
    }
  });

  // total max = 12 * 10 = 120
  const percentage = Math.round((total / 120) * 10000) / 100; // 2 decimals
  const stars = Math.round((percentage / 100) * 5); // 0..5

  // Render results
  totalScoreEl.textContent = total.toFixed(2);
  percentageEl.textContent = percentage.toFixed(2) + '%';
  renderStars(stars);

  return { total, percentage, stars, values };
}

/* render stars */
function renderStars(stars){
  ratingStarsEl.innerHTML = '';
  for(let i=0;i<5;i++){
    const s = document.createElement('span');
    s.style.fontSize='22px';
    s.style.marginRight='6px';
    s.textContent = (i < stars) ? '★' : '☆';
    s.style.color = (i < stars) ? 'gold' : '#ddd';
    ratingStarsEl.appendChild(s);
  }
}

/* wire UI events */
function wireEvents(){
  // buttons may not exist if earlier DOM missing; guard
  const btnSave = document.getElementById('btnSaveLocal');
  if(btnSave) btnSave.addEventListener('click', saveEntryLocal);
  const btnLoad = document.getElementById('btnLoadLocal');
  if(btnLoad) btnLoad.addEventListener('click', loadEntriesToUI);
  const btnClear = document.getElementById('btnClearLocal');
  if(btnClear) btnClear.addEventListener('click', clearLocalEntries);

  btnExportCSV.addEventListener('click', exportCSV);
  btnExportImage.addEventListener('click', ()=> openModal());
  btnDownload.addEventListener('click', ()=> openModal());
  btnReset.addEventListener('click', resetForm);

  document.getElementById('modalBackdrop').addEventListener('click', (e)=>{ if(e.target.id==='modalBackdrop') closeModal(); });
}

/* Local storage functions */
function saveEntryLocal(){
  const { total, percentage, stars, values } = computeAndRenderScore();
  const entry = {
    id: 'e_' + Date.now(),
    building: buildingEl.value.trim(),
    floor: floorEl.value.trim(),
    counter: counterEl.value.trim(),
    date: dateEl.value,
    timestamp: new Date().toISOString(),
    answers: values,
    total, percentage, stars
  };
  const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  arr.push(entry);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  loadEntriesToUI();
  alert('Entry saved locally.');
}

function loadEntriesToUI(){
  const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  entriesBody.innerHTML = '';
  arr.slice().reverse().forEach(e=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${e.date}</td><td>${escapeHTML(e.building)}</td><td>${escapeHTML(e.floor)}</td><td>${escapeHTML(e.counter)}</td><td>${e.total.toFixed(2)}</td><td>${(e.percentage||0).toFixed(2)}%</td><td>${e.stars||0}</td>
      <td>
        <button class="btn small ghost" onclick='loadEntry("${e.id}")'>Load</button>
        <button class="btn small ghost" onclick='deleteEntry("${e.id}")'>Delete</button>
      </td>`;
    entriesBody.appendChild(tr);
  });
  renderMiniChart();
}

function loadEntry(id){
  const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  const e = arr.find(x=>x.id===id);
  if(!e) return alert('Entry not found');
  buildingEl.value = e.building;
  floorEl.value = e.floor;
  counterEl.value = e.counter;
  dateEl.value = e.date;
  // set selects
  Object.keys(e.answers).forEach(k=>{
    const sel = document.querySelector(`select[data-key="${k}"]`);
    if(sel) sel.value = e.answers[k] === undefined ? 'No' : (e.answers[k].charAt(0).toUpperCase() + e.answers[k].slice(1).toLowerCase());
  });
  computeAndRenderScore();
  window.scrollTo({top:0,behavior:'smooth'});
}

function deleteEntry(id){
  if(!confirm('Delete this entry?')) return;
  let arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  arr = arr.filter(x=>x.id!==id);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  loadEntriesToUI();
}

/* Export CSV */
function exportCSV(){
  const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  if(!arr.length) return alert('No data');
  const headers = ['id','date','building','floor','counter','total','percentage','stars','timestamp'];
  const lines = [headers.join(',')];
  arr.forEach(r=>{
    const row = headers.map(h=>JSON.stringify(r[h] ?? '')).join(',');
    lines.push(row);
  });
  const blob = new Blob([lines.join('\n')],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'konarak_audit.csv'; a.click(); URL.revokeObjectURL(url);
}

/* Clear local */
function clearLocalEntries(){
  if(!confirm('Clear all saved entries locally?')) return;
  localStorage.removeItem(STORAGE_KEY);
  loadEntriesToUI();
}

/* Reset */
function resetForm(){
  buildingEl.value=''; floorEl.value=''; counterEl.value='';
  dateEl.value = new Date().toISOString().slice(0,10);
  document.querySelectorAll('.form-control').forEach(s=>s.value='Yes');
  computeAndRenderScore();
}

/* Helpers */
function escapeHTML(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* Mini chart */
function renderMiniChart(){
  const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  const last10 = arr.slice(-10);
  const labels = last10.map(r=>r.date);
  const data = last10.map(r=>r.total);
  const ctx = document.getElementById('miniChart').getContext('2d');
  if(miniChart) miniChart.destroy();
  miniChart = new Chart(ctx, { type:'line', data:{ labels, datasets:[{label:'Score', data, fill:false}] }, options:{plugins:{legend:{display:false}}} );
}

/* Modal */
function openModal(){ document.getElementById('modalBackdrop').style.display='flex'; }
function closeModal(){ document.getElementById('modalBackdrop').style.display='none'; }
function selectVariant(variant){ closeModal(); generateHDImage(variant); }

/* Generate HD image - compact, no empty space */
async function generateHDImage(variant){
  const { total, percentage, stars, values } = computeAndRenderScore();
  const meta = {
    building: buildingEl.value || '—',
    floor: floorEl.value || '—',
    counter: counterEl.value || '—',
    date: dateEl.value || new Date().toISOString().slice(0,10),
    score: total.toFixed(2),
    percentage: percentage.toFixed(2),
    stars
  };

  const renderArea = document.getElementById('renderArea');
  renderArea.innerHTML = '';

  // helper signature element: prefer signature.png, fallback stylized text
  function createSignatureEl(){
    const wrap = document.createElement('div');
    const img = document.createElement('img');
    img.src = 'signature.png';
    img.style.maxWidth = '280px'; img.style.height='auto'; img.style.display='block';
    img.onerror = function(){ img.style.display='none'; const text = document.createElement('div'); text.textContent='Naresh'; text.style.fontFamily="'Brush Script MT',cursive"; text.style.fontSize='40px'; text.style.color='#0b1220'; wrap.appendChild(text); };
    wrap.appendChild(img);
    return wrap;
  }

  function composeShort(values, max=800){
    const lines = QUESTIONS.map(q=>`${q.text.replace('?','')}: ${values[q.key]}`);
    const combined = lines.join(' • ');
    return combined.length > max ? combined.slice(0,max-3) + '...' : combined;
  }

  // Variant A: landscape 1600x1000
  if(variant === 'A'){
    renderArea.style.width='1600px'; renderArea.style.height='1000px';
    const card = document.createElement('div');
    card.style.width='1560px'; card.style.height='960px'; card.style.margin='20px auto'; card.style.padding='24px';
    card.style.borderRadius='16px'; card.style.background='linear-gradient(180deg,#fffef9,#fffaf3)'; card.style.border='6px solid #f3e6c6';
    card.style.boxShadow='0 20px 60px rgba(12,12,12,0.18)'; card.style.boxSizing='border-box'; card.style.display='flex'; card.style.flexDirection='column'; card.style.justifyContent='space-between';

    // header
    const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
    const logo = document.createElement('img'); logo.src='logo.png'; logo.style.height='72px'; logo.onerror = ()=>logo.style.display='none';
    const title = document.createElement('div'); title.innerHTML=`<div style="font-size:24px;font-weight:800;color:#111">Stall Audit Rating Certificate</div><div style="color:#475569;margin-top:6px">Konarak Food & Beverages</div>`;
    header.appendChild(logo); header.appendChild(title);
    card.appendChild(header);

    // middle
    const mid = document.createElement('div'); mid.style.display='flex'; mid.style.justifyContent='space-between'; mid.style.alignItems='flex-start';
    const left = document.createElement('div'); left.style.flex='1';
    left.innerHTML = `<div style="font-size:20px;color:#0b1220;font-weight:800">${escapeHTML(meta.counter)}</div>
      <div style="margin-top:8px;color:#475569">Building: <strong>${escapeHTML(meta.building)}</strong> &nbsp; • &nbsp; Floor: <strong>${escapeHTML(meta.floor)}</strong> &nbsp; • &nbsp; Date: <strong>${escapeHTML(meta.date)}</strong></div>
      <div style="margin-top:14px;font-size:13px;color:#475569">Remarks</div>
      <div class="render-remarks" style="margin-top:8px;background:#fff;border-radius:10px;padding:12px;border:1px solid rgba(12,20,40,0.04);min-height:80px">${escapeHTML(composeShort(values,700))}</div>`;
    mid.appendChild(left);

    const right = document.createElement('div'); right.style.width='300px'; right.style.flex='0 0 300px'; right.style.textAlign='center';
    right.innerHTML = `<div style="font-size:12px;color:#6b6b6b">Score</div><div style="font-size:42px;font-weight:900;color:#0b1220;margin-top:6px">${meta.score}</div><div style="margin-top:12px;font-size:14px;color:#475569">${meta.percentage}%</div><div id="cardStars" style="margin-top:12px"></div>`;
    mid.appendChild(right);

    card.appendChild(mid);

    // bottom
    const bottom = document.createElement('div'); bottom.style.display='flex'; bottom.style.justifyContent='space-between'; bottom.style.alignItems='center';
    const signatureEl = createSignatureEl(); signatureEl.style.display='block';
    bottom.appendChild(signatureEl);

    const seal = document.createElement('div'); seal.style.width='120px'; seal.style.height='120px'; seal.style.borderRadius='50%';
    seal.style.display='flex'; seal.style.alignItems='center'; seal.style.justifyContent='center'; seal.style.border='3px solid rgba(212,175,55,0.6)';
    seal.innerHTML = `<div style="text-align:center"><div style="font-weight:800;color:#1b2430">KONARAK</div><div style="font-size:11px;color:#6b7280">Food & Beverages</div><div style="font-size:20px;color:#d4af37;margin-top:6px">✦</div></div>`;
    bottom.appendChild(seal);

    card.appendChild(bottom);
    renderArea.appendChild(card);

    // stars
    const starsDiv = card.querySelector('#cardStars');
    for(let i=0;i<5;i++){ const sp=document.createElement('span'); sp.textContent = (i < meta.stars) ? '★' : '☆'; sp.style.fontSize='26px'; sp.style.color=(i < meta.stars)?'gold':'#ddd'; sp.style.marginRight='4px'; starsDiv.appendChild(sp); }

  } else if (variant === 'B'){
    // Vertical mobile-friendly 1080x1600
    renderArea.style.width='1080px'; renderArea.style.height='1600px';
    const card = document.createElement('div'); card.style.width='1000px'; card.style.height='1540px'; card.style.margin='30px auto'; card.style.padding='36px'; card.style.borderRadius='24px';
    card.style.boxSizing='border-box'; card.style.background='linear-gradient(180deg,#0b1220,#1c3ea6)'; card.style.color='#fff'; card.style.display='flex'; card.style.flexDirection='column'; card.style.justifyContent='space-between';

    const logo = document.createElement('img'); logo.src='logo.png'; logo.style.height='100px'; logo.onerror = ()=>logo.style.display='none';
    const head = document.createElement('div'); head.style.display='flex'; head.style.justifyContent='space-between'; head.appendChild(logo); card.appendChild(head);

    const big = document.createElement('div'); big.style.textAlign='center';
    big.innerHTML = `<div style="font-size:44px;font-weight:900">${escapeHTML(meta.counter)}</div><div style="margin-top:8px;font-size:18px;opacity:0.9">${escapeHTML(meta.building)} • Floor ${escapeHTML(meta.floor)}</div>`;
    card.appendChild(big);

    const starsRow = document.createElement('div'); starsRow.style.display='flex'; starsRow.style.justifyContent='center'; starsRow.style.marginTop='20px';
    for(let i=0;i<5;i++){ const s=document.createElement('span'); s.textContent=(i < meta.stars)?'★':'☆'; s.style.fontSize='48px'; s.style.margin='6px'; s.style.color=(i<meta.stars)?'gold':'rgba(255,255,255,0.28)'; starsRow.appendChild(s); }
    card.appendChild(starsRow);

    const score = document.createElement('div'); score.style.textAlign='center'; score.style.marginTop='18px'; score.innerHTML=`<div style="font-size:16px;opacity:0.9">Score</div><div style="font-size:64px;font-weight:900">${meta.score}</div><div style="margin-top:10px;font-size:16px">${meta.percentage}%</div>`;
    card.appendChild(score);

    const remarks = document.createElement('div'); remarks.style.marginTop='22px'; remarks.style.padding='12px'; remarks.style.background='rgba(255,255,255,0.06)'; remarks.style.borderRadius='10px'; remarks.innerHTML = `<div style="font-size:14px;opacity:0.9">Remarks</div><div style="margin-top:8px;font-size:14px">${escapeHTML(composeShort(values,1200))}</div>`;
    card.appendChild(remarks);

    const bottom = document.createElement('div'); bottom.style.display='flex'; bottom.style.justifyContent='space-between'; bottom.style.alignItems='center';
    const sig = createSignatureEl(); bottom.appendChild(sig);
    const seal = document.createElement('div'); seal.style.width='110px'; seal.style.height='110px'; seal.style.borderRadius='50%'; seal.style.border='5px solid rgba(255,255,255,0.14)'; seal.style.display='flex'; seal.style.alignItems='center'; seal.style.justifyContent='center'; seal.innerHTML=`<div style="text-align:center;color:#fff"><div style="font-weight:800;font-size:20px">K</div><div style="font-size:11px;opacity:0.9">Konarak</div></div>`;
    bottom.appendChild(seal);
    card.appendChild(bottom);

    renderArea.appendChild(card);

  } else {
    // Variant C: minimal 1400x900
    renderArea.style.width='1400px'; renderArea.style.height='900px';
    const card = document.createElement('div'); card.style.width='1360px'; card.style.height='860px'; card.style.margin='20px auto'; card.style.padding='22px'; card.style.borderRadius='14px'; card.style.background='#fff'; card.style.boxShadow='0 18px 46px rgba(12,20,35,0.06)'; card.style.boxSizing='border-box';
    const top = document.createElement('div'); top.style.display='flex'; top.style.justifyContent='space-between'; top.style.alignItems='center';
    const left = document.createElement('div'); left.innerHTML = `<img src="logo.png" style="height:60px" onerror="this.style.display='none'"><div style="font-size:18px;font-weight:700;margin-top:6px">Konarak Food & Beverages</div>`;
    const right = document.createElement('div'); right.style.textAlign='right'; right.innerHTML = `<div style="font-size:12px;color:#6b7280">Date</div><div style="font-size:16px">${escapeHTML(meta.date)}</div>`;
    top.appendChild(left); top.appendChild(right); card.appendChild(top);

    const mid = document.createElement('div'); mid.style.display='flex'; mid.style.justifyContent='space-between'; mid.style.marginTop='22px';
    const info = document.createElement('div'); info.innerHTML = `<div style="font-size:14px;color:#6b7280">Counter</div><div style="font-size:32px;font-weight:800">${escapeHTML(meta.counter)}</div><div style="margin-top:8px;color:#475569">Building: ${escapeHTML(meta.building)} • Floor: ${escapeHTML(meta.floor)}</div>`;
    const scoreBox = document.createElement('div'); scoreBox.style.textAlign='center'; scoreBox.innerHTML = `<div style="font-size:12px;color:#6b7280">Score</div><div style="font-size:44px;font-weight:900">${meta.score}</div><div style="margin-top:8px">${meta.percentage}%</div><div id="ctStars" style="margin-top:8px"></div>`;
    mid.appendChild(info); mid.appendChild(scoreBox); card.appendChild(mid);

    const remarks = document.createElement('div'); remarks.style.marginTop='18px'; remarks.style.padding='12px'; remarks.style.borderRadius='10px'; remarks.style.background='#fbfbfb'; remarks.innerHTML = `<div style="font-size:13px;color:#6b7280">Remarks</div><div style="margin-top:6px;color:#333" class="render-remarks">${escapeHTML(composeShort(values,800))}</div>`;
    card.appendChild(remarks);

    const bottom = document.createElement('div'); bottom.style.display='flex'; bottom.style.justifyContent='flex-end'; bottom.style.marginTop='18px';
    const signatureEl = createSignatureEl(); bottom.appendChild(signatureEl);
    card.appendChild(bottom);

    renderArea.appendChild(card);

    // stars
    const starsDiv = renderArea.querySelector('#ctStars');
    for(let i=0;i<5;i++){ const sp=document.createElement('span'); sp.textContent=(i < meta.stars)?'★':'☆'; sp.style.color=(i<meta.stars)?'gold':'#ddd'; sp.style.fontSize='20px'; sp.style.marginRight='4px'; starsDiv.appendChild(sp); }

  }

  // ensure images loaded
  await waitForImages(renderArea);

  // render with html2canvas
  try {
    const scale = 2; // HD
    const opts = { backgroundColor: null, scale: scale, useCORS: true };
    const node = renderArea.firstChild;
    const canvas = await html2canvas(node, opts);
    canvas.toBlob(function(blob){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const safeCounter = meta.counter.replace(/\s+/g,'_') || 'counter';
      a.download = `konarak_rating_${safeCounter}_${meta.date}.png`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }, 'image/png', 1.0);
  } catch(err){
    alert('Image export failed: ' + err.message);
    console.error(err);
  } finally {
    renderArea.innerHTML = '';
  }
}

/* helper wait for images */
function waitForImages(container){
  const imgs = Array.from(container.querySelectorAll('img'));
  return Promise.all(imgs.map(img=>{
    return new Promise(resolve=>{ if(img.complete) return resolve(); img.onload = resolve; img.onerror = resolve; });
  }));
}

/* compose answers short */
function composeShort(values, max){
  const lines = QUESTIONS.map(q=>`${q.text.replace('?','')}: ${values[q.key]}`);
  const combined = lines.join(' • ');
  return combined.length > max ? combined.slice(0,max-3) + '...' : combined;
}

/* expose for table buttons */
window.loadEntry = loadEntry;
window.deleteEntry = deleteEntry;
</script>

</body>
</html>
