<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stall Audit â€” Local System</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- jsPDF + html2canvas (for PDF export) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root{
  --bg:#f5f7fb; --card:#ffffff; --accent:#1f71ff; --muted:#6b7280; --danger:#d9534f;
}
body{margin:0;background:var(--bg);font-family:Arial,Helvetica,sans-serif;color:#111;}
.header{background:#fff;padding:12px 16px;border-bottom:1px solid #e2e8f0;}
.header .wrap{max-width:1100px;margin:auto;display:flex;justify-content:space-between;align-items:center;}
.container{max-width:1100px;margin:20px auto;padding:0 16px;}
.card{background:var(--card);padding:16px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.05);margin-bottom:16px;}
input,select,textarea{width:100%;padding:8px;margin:6px 0;border:1px solid #cfd7e3;border-radius:6px;}
label{font-size:0.9rem;font-weight:600;}
.button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;}
.button.secondary{background:#fff;color:#1f71ff;border:1px solid #1f71ff;}
.button.small{padding:6px 8px;font-size:0.85rem;}
.table-wrap{overflow:auto;max-height:350px;}
table{width:100%;border-collapse:collapse;}
th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left;font-size:0.9rem;}
th{background:#f8fafc;position:sticky;top:0;}
.summary{display:flex;gap:10px;flex-wrap:wrap;}
.summary .box{background:#fff;padding:12px;border-radius:6px;min-width:140px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,0.05);}
.filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
</style>

</head>
<body>

<header class="header">
  <div class="wrap">
    <h2>Stall Audit System</h2>
    <div>
      <button id="exportCSV" class="button small">Export CSV</button>
      <button id="exportPDF" class="button small">Export PDF</button>
      <button id="clearAll" class="button small secondary">Clear All Data</button>
    </div>
  </div>
</header>

<main class="container">

<!-- Add/Edit Form -->
<div class="card">
  <h3>Add / Edit Entry</h3>

  <form id="entryForm">
    <input type="hidden" id="editId"/>

    <label>Stall</label>
    <input id="stall" placeholder="Stall A / Stall B" required>

    <label>Date</label>
    <input id="date" type="date" required>

    <label>Timestamp</label>
    <input id="timestamp" readonly>

    <div class="card" style="background:#fafbff;margin-top:12px;">
      <label>Daily Sales Submitted?</label>
      <select id="sales_sub"><option>Yes</option><option>No</option></select>

      <label>Daily Feedback Submitted?</label>
      <select id="feedback_sub"><option>Yes</option><option>No</option></select>

      <label>Breakfast On Time?</label>
      <select id="breakfast"><option>Yes</option><option>No</option></select>

      <label>Lunch On Time?</label>
      <select id="lunch"><option>Yes</option><option>No</option></select>

      <label>Dinner On Time?</label>
      <select id="dinner"><option>Yes</option><option>No</option></select>

      <label>Temperature Posted?</label>
      <select id="temp_photo"><option>Yes</option><option>No</option></select>

      <label>Staff Behaviour Good?</label>
      <select id="behaviour"><option>Yes</option><option>No</option></select>

      <label>Staff Hygiene Good?</label>
      <select id="hygiene"><option>Yes</option><option>No</option></select>

      <label>Stall Clean?</label>
      <select id="stall_clean"><option>Yes</option><option>No</option></select>

      <label>Food Quality Complaint?</label>
      <select id="food_complaint"><option>No</option><option>Yes</option></select>

      <label>CBRE Complaint?</label>
      <select id="cbre_complaint"><option>No</option><option>Yes</option></select>

      <label>Cognizant Complaint?</label>
      <select id="cognizant_complaint"><option>No</option><option>Yes</option></select>

      <label>Remarks</label>
      <textarea id="remarks" rows="2"></textarea>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
      <button type="submit" class="button">Save Entry</button>
      <button id="resetBtn" type="button" class="button secondary">Reset</button>
    </div>
  </form>
</div>

<!-- Summary + Filters -->
<div class="card">
  <div class="summary" id="summary"></div>

  <div class="filters" style="margin-top:10px;">
    <label>Stall</label>
    <select id="filterStall"><option value="">All</option></select>

    <label>From</label>
    <input type="date" id="filterFrom">

    <label>To</label>
    <input type="date" id="filterTo">

    <button id="applyFilter" class="button small">Apply</button>
    <button id="clearFilter" class="button small secondary">Clear</button>
  </div>
</div>

<!-- Chart -->
<div class="card">
  <h3>Average Score by Stall</h3>
  <canvas id="chart" height="120"></canvas>
</div>

<!-- Table -->
<div class="card">
  <h3>Audit Entries</h3>
  <div class="table-wrap">
    <table id="table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

</main>

<script>
/* --------------------------
       LOCALSTORAGE LOGIC
---------------------------*/
const KEY = "stall_audit";

function loadData(){
  return JSON.parse(localStorage.getItem(KEY) || "[]");
}
function saveData(arr){
  localStorage.setItem(KEY, JSON.stringify(arr));
}

/* --------------------------
       TIMESTAMP SET
---------------------------*/
function setTimestamp(){
  const now = new Date();
  timestamp.value = now.toISOString().slice(0,19).replace("T"," ");
}
setTimestamp();

/* --------------------------
       SCORING ENGINE
---------------------------*/
function yesNo(value, positive=true){
  value = value.toUpperCase();
  return value==="YES" ? (positive?10:0) : (positive?0:10);
}
function timeScore(a,b,c){
  let t=[a,b,c].map(v=>v==="YES"?1:0);
  return (t[0]+t[1]+t[2])/3 * 10;
}
function compute(entry){
  let s1=yesNo(entry.sales_sub);
  let s2=yesNo(entry.feedback_sub);
  let s3=timeScore(entry.breakfast,entry.lunch,entry.dinner);
  let s4=yesNo(entry.temp_photo);
  let s5=yesNo(entry.behaviour);
  let s6=yesNo(entry.hygiene);
  let s7=yesNo(entry.stall_clean);
  let s8=yesNo(entry.food_complaint,false);
  let s9=yesNo(entry.cbre_complaint,false);
  let s10=yesNo(entry.cognizant_complaint,false);
  let total = s1+s2+s3+s4+s5+s6+s7+s8+s9+s10;
  let rating = (total/100)*5;
  return {score:total, rating:+rating.toFixed(2)};
}

/* --------------------------
       SAVE ENTRY
---------------------------*/
entryForm.onsubmit = function(e){
  e.preventDefault();

  let entry = {
    id: editId.value || "id"+Date.now(),
    stall: stall.value.trim(),
    date: date.value,
    timestamp: timestamp.value,

    sales_sub: sales_sub.value,
    feedback_sub: feedback_sub.value,
    breakfast: breakfast.value,
    lunch: lunch.value,
    dinner: dinner.value,
    temp_photo: temp_photo.value,
    behaviour: behaviour.value,
    hygiene: hygiene.value,
    stall_clean: stall_clean.value,
    food_complaint: food_complaint.value,
    cbre_complaint: cbre_complaint.value,
    cognizant_complaint: cognizant_complaint.value,
    remarks: remarks.value
  };

  let calc = compute(entry);
  entry.total_score = calc.score;
  entry.rating = calc.rating;

  let data = loadData();
  let i = data.findIndex(x=>x.id===entry.id);
  if(i>=0) data[i]=entry; else data.push(entry);

  saveData(data);
  resetForm();
  refresh();
};

resetBtn.onclick = resetForm;

function resetForm(){
  entryForm.reset();
  editId.value="";
  setTimestamp();
}

/* --------------------------
       EDIT / DELETE
---------------------------*/
function editEntry(id){
  let data = loadData();
  let e = data.find(x=>x.id===id);
  if(!e) return;

  editId.value = e.id;
  stall.value = e.stall;
  date.value = e.date;
  timestamp.value = e.timestamp;
  sales_sub.value = e.sales_sub;
  feedback_sub.value = e.feedback_sub;
  breakfast.value = e.breakfast;
  lunch.value = e.lunch;
  dinner.value = e.dinner;
  temp_photo.value = e.temp_photo;
  behaviour.value = e.behaviour;
  hygiene.value = e.hygiene;
  stall_clean.value = e.stall_clean;
  food_complaint.value = e.food_complaint;
  cbre_complaint.value = e.cbre_complaint;
  cognizant_complaint.value = e.cognizant_complaint;
  remarks.value = e.remarks;

  window.scrollTo({top:0,behavior:'smooth'});
}

function deleteEntry(id){
  if(!confirm("Delete this record?")) return;
  let data = loadData().filter(x=>x.id!==id);
  saveData(data);
  refresh();
}

/* --------------------------
       FILTER LOGIC
---------------------------*/
function applyFilters(data){
  let s = filterStall.value;
  let f = filterFrom.value;
  let t = filterTo.value;

  return data.filter(e=>{
    if(s && e.stall!==s) return false;
    if(f && e.date < f) return false;
    if(t && e.date > t) return false;
    return true;
  });
}

applyFilter.onclick = refresh;
clearFilter.onclick = ()=>{
  filterStall.value="";
  filterFrom.value="";
  filterTo.value="";
  refresh();
};

/* --------------------------
       RENDER SUMMARY
---------------------------*/
function renderSummary(data){
  if(!data.length){
    summary.innerHTML = "<div class='box'>No records found</div>";
    return;
  }

  let avg = data.reduce((a,b)=>a+b.total_score,0)/data.length;
  let max = Math.max(...data.map(e=>e.total_score));
  let min = Math.min(...data.map(e=>e.total_score));
  let best = data.find(e=>e.total_score===max)?.stall || "-";
  let worst = data.find(e=>e.total_score===min)?.stall || "-";

  summary.innerHTML = `
    <div class="box"><b>${data.length}</b><br>Records</div>
    <div class="box"><b>${avg.toFixed(2)}</b><br>Avg Score</div>
    <div class="box"><b>${best}</b><br>Best Stall</div>
    <div class="box"><b>${worst}</b><br>Worst Stall</div>
  `;
}

/* --------------------------
       RENDER TABLE
---------------------------*/
function renderTable(data){
  const thead = table.querySelector("thead");
  const tbody = table.querySelector("tbody");
  thead.innerHTML="";
  tbody.innerHTML="";

  const cols = ["timestamp","stall","date","total_score","rating",
    "sales_sub","feedback_sub","breakfast","lunch","dinner","temp_photo",
    "behaviour","hygiene","stall_clean","food_complaint","cbre_complaint","cognizant_complaint","remarks"
  ];

  // header
  let tr=document.createElement("tr");
  cols.concat("actions").forEach(c=>{
    let th=document.createElement("th"); th.textContent=c.replace(/_/g," ");
    tr.appendChild(th);
  });
  thead.appendChild(tr);

  // rows
  data.slice().reverse().forEach(e=>{
    let tr=document.createElement("tr");
    cols.forEach(c=>{
      let td=document.createElement("td"); td.textContent=e[c] ?? "";
      tr.appendChild(td);
    });
    let td=document.createElement("td");
    td.innerHTML=`
      <button class="button small" onclick="editEntry('${e.id}')">Edit</button>
      <button class="button small secondary" onclick="deleteEntry('${e.id}')">Del</button>
    `;
    tr.appendChild(td);
    tbody.appendChild(tr);
  });
}

/* --------------------------
       CHART RENDER
---------------------------*/
let chartInstance=null;
function renderChart(data){
  let map={};
  data.forEach(e=>{
    if(!map[e.stall]) map[e.stall]=[];
    map[e.stall].push(e.total_score);
  });

  let labels = Object.keys(map);
  let vals = labels.map(s=>{
    let a=map[s]; return (a.reduce((x,y)=>x+y,0)/a.length).toFixed(2);
  });

  if(chartInstance) chartInstance.destroy();

  const ctx=document.getElementById("chart").getContext("2d");
  chartInstance=new Chart(ctx,{
    type:"bar",
    data:{labels,datasets:[{label:"Avg Score",data:vals,backgroundColor:"rgba(31,113,255,0.7)"}]},
    options:{scales:{y:{beginAtZero:true,max:100}}}
  });
}

/* --------------------------
       EXPORT CSV
---------------------------*/
exportCSV.onclick = ()=>{
  let data = applyFilters(loadData());
  if(!data.length){ alert("No data"); return; }

  let headers = Object.keys(data[0]);
  let csv = [headers.join(",")];

  data.forEach(e=>{
    csv.push(headers.map(h=>JSON.stringify(e[h]??"")).join(","));
  });

  let blob=new Blob([csv.join("\n")],{type:"text/csv"});
  let url=URL.createObjectURL(blob);
  let a=document.createElement("a");
  a.href=url; a.download="stall_audit.csv"; a.click();
  URL.revokeObjectURL(url);
}

/* --------------------------
       EXPORT PDF
---------------------------*/
exportPDF.onclick=async ()=>{
  let data = applyFilters(loadData());
  if(!data.length){ alert("No data"); return; }

  // Create print view
  const w=window.open("","_blank");
  w.document.write("<h2>Stall Audit Export</h2><table border='1' cellspacing='0' cellpadding='6'><thead><tr>");

  let headers=Object.keys(data[0]);
  headers.forEach(h=>w.document.write("<th>"+h+"</th>"));
  w.document.write("</tr></thead><tbody>");

  data.forEach(e=>{
    w.document.write("<tr>");
    headers.forEach(h=>w.document.write("<td>"+(e[h]??"")+"</td>"));
    w.document.write("</tr>");
  });
  w.document.write("</tbody></table>");
  w.document.close();

  // Convert to PDF
  const canvas = await html2canvas(w.document.body,{scale:1});
  const img = canvas.toDataURL("image/png");
  const pdf = new jspdf.jsPDF("p","mm","a4");
  const wPdf = pdf.internal.pageSize.getWidth()-20;
  const hPdf = (canvas.height * wPdf) / canvas.width;
  pdf.addImage(img,"PNG",10,10,wPdf,hPdf);
  pdf.save("stall_audit.pdf");
  w.close();
};

/* --------------------------
       CLEAR ALL
---------------------------*/
clearAll.onclick = ()=>{
  if(confirm("Clear all records?")){ localStorage.removeItem(KEY); refresh(); }
}

/* --------------------------
       REFRESH UI
---------------------------*/
function refresh(){
  let data = loadData();
  let stalls=[...new Set(data.map(e=>e.stall))];
  filterStall.innerHTML="<option value=''>All</option>"+stalls.map(s=>`<option>${s}</option>`).join("");

  let filtered = applyFilters(data);
  renderSummary(filtered);
  renderTable(filtered);
  renderChart(filtered);
}

refresh();

</script>

</body>
</html>
