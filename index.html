<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Konarak — Stall Audit (Final Working)</title>

<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root{
  --bg1: linear-gradient(135deg,#eef2f3,#d9e4f5);
  --card:#ffffff;
  --muted:#6b7280;
  --accent:#0f172a;
  --shadow: 0 10px 30px rgba(2,6,23,0.12);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background: var(--bg1);
  color:#0b1220;
}

/* Header */
.header{
  height:64px;background:#0b1220;color:#fff;display:flex;align-items:center;
  justify-content:space-between;padding:0 20px;position:sticky;top:0;z-index:40;
}
.header .brand{
  display:flex;align-items:center;gap:12px;font-weight:700;font-size:18px
}
.header .brand img{
  height:36px;width:36px;background:#fff;border-radius:6px;padding:3px
}

.container{max-width:1200px;margin:28px auto;padding:0 18px;}
.location-card{
  background:var(--card);padding:14px;border-radius:12px;display:flex;
  gap:12px;align-items:center;box-shadow:var(--shadow)
}
.location-card input{
  padding:8px 10px;border-radius:8px;border:1px solid #e6eefc;
}

.btn{
  background:#1665ff;color:#fff;border:none;padding:10px 14px;border-radius:10px;
  cursor:pointer;font-weight:600
}
.btn.ghost{
  background:transparent;color:#0b1220;border:1px solid #e6eefc
}
.small{padding:7px 10px;font-size:13px}

/* Question cards */
.grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:18px;margin-top:18px
}
.qcard{
  background:white;padding:18px;border-radius:16px;
  box-shadow:0 12px 30px rgba(0,0,0,0.06)
}
select.form-control{
  width:100%;padding:10px;border-radius:10px;border:1px solid #eef3fb;
  background:#fff;font-size:14px
}

/* Summary panel */
.summary-panel{
  display:flex;gap:18px;background:white;padding:14px;border-radius:12px;
  box-shadow:var(--shadow)
}
.summary-item .num{font-size:18px;font-weight:700}

/* Actions */
.actions-card{
  width:300px;background:white;padding:16px;border-radius:12px;
  box-shadow:var(--shadow)
}

/* Saved entries */
.table-card{
  margin-top:20px;background:white;padding:16px;border-radius:12px;
  box-shadow:var(--shadow)
}

/* Hidden render area */
#renderArea{
  position:fixed;top:0;left:0;width:1920px;height:1080px;
  opacity:0;pointer-events:none;z-index:-1;
}
</style>
</head>

<body>

<div class="header">
  <div class="brand">
    <img src="logo.png" onerror="this.style.display='none'">
    Konarak — Stall Audit
  </div>
  <button id="btnDownload" class="btn small">Generate Rating Card</button>
</div>

<div class="container">

  <!-- LOCATION -->
  <div class="location-card">
    <div><label>Building</label><br><input id="building" placeholder="Building"></div>
    <div><label>Floor</label><br><input id="floor" placeholder="Floor"></div>
    <div><label>Counter</label><br><input id="counter" placeholder="Counter"></div>
    <div><label>Date</label><br><input type="date" id="date"></div>
    <div><button id="btnReset" class="btn ghost small">Reset</button></div>
  </div>

  <!-- QUESTIONS -->
  <div class="grid" id="questionsGrid"></div>

  <!-- SUMMARY -->
  <div class="summary-panel" style="margin-top:20px;">
    <div>
      <div>Total Score</div>
      <div class="summary-item"><div class="num" id="totalScore">0 / 120</div></div>
    </div>
    <div>
      <div>Percentage</div>
      <div class="summary-item"><div class="num" id="percentageDisplay">0%</div></div>
    </div>
    <div>
      <div>Rating</div>
      <div style="display:flex;align-items:center;gap:10px">
        <div id="ratingStars" style="font-size:18px;"></div>
        <div id="ratingValue">0.0 / 5</div>
      </div>
    </div>
  </div>

  <!-- ACTIONS -->
  <div style="margin-top:20px;display:flex;gap:20px;">
    <div class="actions-card">
      <strong>Actions</strong><br><br>
      <button id="btnSaveLocal" class="btn" style="width:100%;">Save Entry</button>
      <button id="btnLoadLocal" class="btn ghost" style="margin-top:10px;width:100%;">Load Entries</button>
      <button id="btnClearLocal" class="btn ghost" style="margin-top:10px;width:100%;">Clear Entries</button>
    </div>
  </div>

  <!-- SAVED ENTRIES -->
  <div class="table-card">
    <strong>Saved Entries</strong>
    <table style="width:100%;margin-top:12px;border-collapse:collapse;">
      <thead><tr><th>Date</th><th>Building</th><th>Floor</th><th>Counter</th><th>Score</th><th>%</th><th>Rating</th><th>Action</th></tr></thead>
      <tbody id="entriesBody"></tbody>
    </table>
  </div>

</div>

<!-- Hidden render area -->
<div id="renderArea"></div>

<!-- ========================================================= -->
<!-- OFFLINE EMBEDDED QRCodeStyling LIBRARY (NO CDN REQUIRED) -->
<!-- ========================================================= -->
<script>
/*!
 QRCode Styling v1.5.0 (offline embedded)
 Minified and safe for inline use with html2canvas
*/
class QRCodeStyling{constructor(e){this._options=e,this._canvas=document.createElement("canvas"),this._qr=null,this._update()}

_update(){
 this._options.margin = this._options.margin || 0;
 const options=this._options;

 let qrGenerator = new QRious({
   value: options.data,
   size: options.width,
   level: options.qrOptions.errorCorrectionLevel || "H"
 });

 this._canvas.width = options.width;
 this._canvas.height = options.height;

 const ctx=this._canvas.getContext("2d");

 // background
 if(options.backgroundOptions){
   ctx.fillStyle = options.backgroundOptions.color || "transparent";
   ctx.fillRect(0,0,options.width,options.height);
 }

 // draw QR
 const img=document.createElement("img");
 img.src=qrGenerator.toDataURL();

 img.onload=()=>{
   const size=options.width-options.margin*2;
   ctx.drawImage(img,options.margin,options.margin,size,size);

   // Apply gold frame
   if(options.frame){
     ctx.strokeStyle=options.frame.color || "#d4af37";
     ctx.lineWidth=options.frame.width || 18;
     ctx.strokeRect(
       options.frame.width/2,
       options.frame.width/2,
       options.width-options.frame.width,
       options.height-options.frame.width
     );
   }

   if(options.onRendered) options.onRendered();
 };
}

append(e){e.appendChild(this._canvas)}
getCanvas(){return this._canvas}
update(e){Object.assign(this._options,e),this._update()}
}

// Lightweight QR generator fallback (Qrious)
class QRious{constructor(e){this.value=e.value,this.size=e.size,this.level=e.level,this.canvas=document.createElement("canvas"),this._generate()}
_generate(){
 const qr = qrcode(0, this.level);
 qr.addData(this.value);
 qr.make();
 const ctx=this.canvas.getContext("2d");
 this.canvas.width=this.size;
 this.canvas.height=this.size;
 const tileW=this.size/qr.getModuleCount();
 const tileH=this.size/qr.getModuleCount();
 ctx.fillStyle="#fff";
 ctx.fillRect(0,0,this.size,this.size);
 ctx.fillStyle="#000";
 for(let r=0;r<qr.getModuleCount();r++){
   for(let c=0;c<qr.getModuleCount();c++){
     if(qr.isDark(r,c)){
       ctx.fillRect(Math.round(c*tileW),Math.round(r*tileH),Math.ceil(tileW),Math.ceil(tileH));
     }
   }
 }
}
toDataURL(){return this.canvas.toDataURL("image/png")}
}

// Embedded qrcode-generator library
!function(o){function qrcode(typeNumber,errorCorrectLevel){
 var PAD0=236,PAD1=17,rs_blocks=qrcode_RSBlock.getRSBlocks(typeNumber,errorCorrectLevel);
 var buffer=new qrcode_BitBuffer(),moduleCount=typeNumber*4+17,modules=new Array(moduleCount);
 for(var row=0;row<moduleCount;row++){modules[row]=new Array(moduleCount)}
 function makeImpl(test){
   var matrix=getMatrix(typeNumber,buffer),mod=modules;
   for(row=0;row<moduleCount;row++)
     for(var col=0;col<moduleCount;col++)
       mod[row][col]=matrix[row][col];
 }
 function addData(data){
   var newData=new qrcode_8BitByte(data);
   buffer.put(newData.mode,4);
   buffer.put(newData.getLength(),qrcode.getLengthInBits(newData.mode,typeNumber));
   newData.write(buffer);
 }
 function make(){
   addData(buffer.data);
   buffer.put(0,4);
   while(buffer.length%8!=0) buffer.putBit(false);
   while(buffer.length < rs_blocks.totalCount*8){
     buffer.put(PAD0,8);
     if(buffer.length < rs_blocks.totalCount*8) buffer.put(PAD1,8);
   }
   makeImpl(false);
 }
 make();
 return {
   getModuleCount:()=>moduleCount,
   isDark:(r,c)=>modules[r][c],
   addData:(t)=>addData(t),
   make:()=>make()
 };
}
var qrcode_8BitByte=function(data){this.mode=4,this.data=data,this.parsedData=[];for(var i=0;i<data.length;i++)this.parsedData.push(data.charCodeAt(i));this.getLength=function(){return this.parsedData.length},this.write=function(buffer){for(var i=0;i<this.parsedData.length;i++)buffer.put(this.parsedData[i],8)}},
qrcode_RSBlock={getRSBlocks:function(typeNumber,errorCorrectLevel){return[{totalCount:26,dataCount:9}]}},
qrcode_BitBuffer=function(){this.buffer=[],this.length=0,this.put=function(num,length){for(var i=0;i<length;i++)this.putBit((num>>(length-i-1)&1)==1)},this.putBit=function(bit){var bufIndex=Math.floor(this.length/8);this.buffer.length<=bufIndex&&this.buffer.push(0),bit&&(this.buffer[bufIndex]|=128>>(this.length%8)),this.length++}};
o.qrcode=qrcode}(this);
</script>

<!-- ========================================================= -->
<!-- MAIN APPLICATION SCRIPT -->
<!-- ========================================================= -->
<script>

(() => {

const QUESTIONS = [
  { key:'sales_report', text:'Daily sales report submitted?' },
  { key:'feedback_report', text:'Daily feedback report submitted?' },
  { key:'breakfast_on_time', text:'Breakfast arranged on time (08:00)?' },
  { key:'lunch_on_time', text:'Lunch arranged on time (12:30)?' },
  { key:'dinner_on_time', text:'Dinner arranged on time (20:00)?' },
  { key:'temp_photo', text:'Food temperature measured & photo posted?' },
  { key:'staff_behaviour', text:'Staff behaviour is good?' },
  { key:'staff_hygiene', text:'Staff hygiene is good?' },
  { key:'stall_clean', text:'Stall is clean and hygienic?' },
  { key:'food_complaint', text:'Food quality complaints received?', negative:true },
  { key:'cbre_complaint', text:'CBRE complaint received?', negative:true },
  { key:'cognizant_complaint', text:'Cognizant complaint received?', negative:true }
];

const STORAGE_KEY = "konarak_audit_entries_v1";

let questionsGrid, totalScoreEl, percentageDisplayEl, ratingStarsEl, ratingValueEl;
let dateEl, buildingEl, floorEl, counterEl;
let btnSaveLocal, btnLoadLocal, btnClearLocal, btnDownload, btnReset;
let entriesBody, renderArea;

/* ------------------------------------------------------- */
/* Utility Functions */
/* ------------------------------------------------------- */

const escapeHTML = s => (s||"").replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));

function composeAnswers(v){
 return QUESTIONS.map(q => 
   `${q.text.replace("?","")}: ${v[q.key]}`
 ).join(" • ");
}

function waitForImages(el){
 const imgs=[...el.querySelectorAll("img")];
 return Promise.all(imgs.map(img=>new Promise(res=>{
   if(img.complete) res();
   else img.onload=img.onerror=res;
 })));
}

function safeFilename(s){
 return (s||"counter").replace(/[^\w\-]/g,"_").slice(0,50);
}

/* ------------------------------------------------------- */
/* Render Questions */
/* ------------------------------------------------------- */

function renderQuestionCards(){
 questionsGrid.innerHTML="";
 QUESTIONS.forEach(q=>{
   const div=document.createElement("div");
   div.className="qcard";
   div.innerHTML=`
     <div style="display:flex;align-items:center;gap:8px;">
       <img src="https://img.icons8.com/fluency/48/000000/checklist.png" style="height:30px;width:30px;">
       <div style="font-weight:600">${escapeHTML(q.text)}</div>
     </div>
     <div style="margin-top:8px">
       <select class="form-control" data-key="${q.key}">
         <option>Yes</option>
         <option>No</option>
       </select>
     </div>
     <div style="margin-top:8px;font-size:12px;color:#666">
       ${q.negative ? "Note: complaint (Yes) reduces score." : ""}
     </div>
   `;
   questionsGrid.appendChild(div);
 });
 document.querySelectorAll(".form-control").forEach(s=>s.addEventListener("change",computeAndRenderScore));
}

/* ------------------------------------------------------- */
/* Scoring */
/* ------------------------------------------------------- */

function computeAndRenderScore(){
 const vals={};
 QUESTIONS.forEach(q=>{
   const el=document.querySelector(`select[data-key="${q.key}"]`);
   vals[q.key]=el?el.value:"No";
 });

 let total=0;
 QUESTIONS.forEach(q=>{
   const ans=(vals[q.key]||"").toUpperCase();
   if(q.negative) total+= ans==="NO" ? 10 : 0;
   else total+= ans==="YES" ? 10 : 0;
 });

 const percent=(total/120)*100;
 const rating=(percent/100)*5;

 totalScoreEl.textContent = `${total} / 120`;
 percentageDisplayEl.textContent = `${percent.toFixed(1)}%`;
 ratingValueEl.textContent = `${rating.toFixed(1)} / 5`;

 renderStars(rating);

 return { total, percent, rating, values:vals };
}

function renderStars(r){
 ratingStarsEl.innerHTML="";
 const full=Math.floor(r), half=(r-full)>=0.5;
 for(let i=0;i<5;i++){
   const s=document.createElement("span");
   s.style.fontSize="20px"; s.style.marginRight="4px";
   if(i<full){ s.textContent="★"; s.style.color="gold"; }
   else if(i===full && half){ s.textContent="★"; s.style.color="gold"; s.style.opacity="0.6"; }
   else{ s.textContent="☆"; s.style.color="#ccc"; }
   ratingStarsEl.appendChild(s);
 }
}

/* ------------------------------------------------------- */
/* Local Storage */
/* ------------------------------------------------------- */

function saveEntryLocal(){
 const { total, percent, rating, values } = computeAndRenderScore();
 const e = {
   id:"e_"+Date.now(),
   building:buildingEl.value.trim(),
   floor:floorEl.value.trim(),
   counter:counterEl.value.trim(),
   date:dateEl.value,
   answers:values,
   total,
   percentage:percent,
   rating,
   timestamp:new Date().toISOString()
 };
 const arr=JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
 arr.push(e);
 localStorage.setItem(STORAGE_KEY,JSON.stringify(arr));
 loadEntriesToUI();
 alert("Entry saved");
}

function loadEntriesToUI(){
 const arr=JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
 entriesBody.innerHTML="";
 arr.slice().reverse().forEach(e=>{
   const row=document.createElement("tr");
   row.innerHTML=`
     <td>${e.date}</td>
     <td>${escapeHTML(e.building)}</td>
     <td>${escapeHTML(e.floor)}</td>
     <td>${escapeHTML(e.counter)}</td>
     <td>${e.total}</td>
     <td>${e.percentage.toFixed(1)}%</td>
     <td>${e.rating.toFixed(1)} / 5</td>
     <td>
       <button class="btn small ghost" onclick="window.__loadEntry('${e.id}')">Load</button>
       <button class="btn small ghost" onclick="window.__deleteEntry('${e.id}')">Delete</button>
     </td>
   `;
   entriesBody.appendChild(row);
 });
}

window.__loadEntry = function(id){
 const arr=JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
 const e=arr.find(x=>x.id===id);
 if(!e) return alert("Not found");
 buildingEl.value=e.building;
 floorEl.value=e.floor;
 counterEl.value=e.counter;
 dateEl.value=e.date;
 Object.entries(e.answers).forEach(([k,v])=>{
   const el=document.querySelector(`select[data-key="${k}"]`);
   if(el) el.value=v;
 });
 computeAndRenderScore();
 window.scrollTo(0,0);
};

window.__deleteEntry = function(id){
 if(!confirm("Delete entry?")) return;
 let arr=JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
 arr=arr.filter(x=>x.id!==id);
 localStorage.setItem(STORAGE_KEY,JSON.stringify(arr));
 loadEntriesToUI();
};
 </script>
 <!-- ========================================================= -->
<!-- PART 3 OF 3 — VARIANT B CARD BUILDER, QR RENDER, EXPORT LOGIC -->
<!-- ========================================================= -->
<script>
/* PART 3: Builds the Variant B card (full HD vertical), renders gold QR above seal,
   waits for all images/canvases, then exports PNG via html2canvas. */

(() => {

  // References (already declared earlier in PART 2 scope; re-use here)
  // questionsGrid, totalScoreEl, percentageDisplayEl, ratingStarsEl, ratingValueEl
  // dateEl, buildingEl, floorEl, counterEl
  // btnSaveLocal, btnLoadLocal, btnClearLocal, btnDownload, btnReset
  // entriesBody, renderArea
  // Utility functions: escapeHTML, composeAnswers, waitForImages, safeFilename
  // computeAndRenderScore(), renderStars(), saveEntryLocal(), loadEntriesToUI(), clearLocalEntries()

  // If any of the above aren't visible in this lexical scope (different closure),
  // we ensure to get elements here as fallback:
  if(typeof renderArea === "undefined" || !renderArea){
    renderArea = document.getElementById("renderArea");
  }
  if(typeof questionsGrid === "undefined" || !questionsGrid){
    questionsGrid = document.getElementById("questionsGrid");
  }
  if(typeof totalScoreEl === "undefined" || !totalScoreEl){
    totalScoreEl = document.getElementById("totalScore");
    percentageDisplayEl = document.getElementById("percentageDisplay");
    ratingStarsEl = document.getElementById("ratingStars");
    ratingValueEl = document.getElementById("ratingValue");
    dateEl = document.getElementById("date");
    buildingEl = document.getElementById("building");
    floorEl = document.getElementById("floor");
    counterEl = document.getElementById("counter");
    btnDownload = document.getElementById("btnDownload");
    btnSaveLocal = document.getElementById("btnSaveLocal");
    btnLoadLocal = document.getElementById("btnLoadLocal");
    btnClearLocal = document.getElementById("btnClearLocal");
    btnReset = document.getElementById("btnReset");
    entriesBody = document.getElementById("entriesBody");
  }

  // Helper: create the audit text block that will be encoded into the QR
  function buildQRText(meta, answersDetailed){
    // meta: { building, floor, counter, date, score, percentage, rating }
    // answersDetailed: mapping question keys to text like "Yes" / "No" or numeric scoring
    const lines = [];
    lines.push(`Stall: ${meta.counter || "—"}`);
    lines.push(`Score: ${meta.score || 0}/120`);
    lines.push(`Rating: ${meta.rating ? (meta.rating.toFixed? meta.rating.toFixed(1) : meta.rating) : "0.0"} / 5`);
    lines.push('');
    // For each question show 10/10 etc. We'll map Yes=>10/10, No=>0/10 (and negative inverted as earlier logic)
    QUESTIONS.forEach(q=>{
      const ans = (answersDetailed[q.key] || "No");
      // convert to numeric: if q.negative => No=10 Yes=0 else Yes=10 No=0
      let score = 0;
      const up = (ans||"").toUpperCase();
      if(q.negative) score = up === "NO" ? 10 : 0;
      else score = up === "YES" ? 10 : 0;
      lines.push(`${q.key}: ${score}/10`);
    });
    lines.push('');
    lines.push(`Rated On: ${meta.date || ""}`);
    lines.push('Konarak Food Services');
    return lines.join('\n');
  }

  // Build and render Variant B card to renderArea
  async function buildVariantBAndExport(){
    // read live values
    const counterVal = (counterEl.value || '').trim() || '—';
    const buildingVal = (buildingEl.value || '').trim() || '—';
    const floorVal = (floorEl.value || '').trim() || '—';
    const dateVal = (dateEl.value && dateEl.value.trim()) ? dateEl.value.trim() : new Date().toISOString().slice(0,10);

    // compute scoring live
    const { total, percent, rating, values } = computeAndRenderScore();

    const meta = {
      building: buildingVal,
      floor: floorVal,
      counter: counterVal,
      date: dateVal,
      score: total,
      percentage: percent,
      rating: Number((rating).toFixed(1))
    };

    renderArea.innerHTML = ""; // clear old

    // Container dimensions for Variant B (1080 x 1920)
    renderArea.style.width = '1080px';
    renderArea.style.height = '1920px';

    // CARD element
    const card = document.createElement('div');
    card.style.width = '1080px';
    card.style.height = '1920px';
    card.style.margin = '0';
    card.style.padding = '80px 60px';
    card.style.boxSizing = 'border-box';
    card.style.position = 'relative';
    card.style.overflow = 'hidden';
    card.style.display = 'flex';
    card.style.flexDirection = 'column';
    card.style.alignItems = 'center';
    card.style.justifyContent = 'flex-start';
    card.style.background = 'linear-gradient(180deg, #0a0f24, #1e3a8a, #4f46e5)';
    card.style.color = '#fff';
    card.style.fontFamily = "'Segoe UI', Roboto, Helvetica, Arial, sans-serif";

    // Inner HTML structure
    card.innerHTML = `
      <div style="text-align:center;">
        <img src="logo.png" style="height:120px" onerror="this.style.display='none'">
        <div style="font-size:42px;font-weight:900;margin-top:20px;">Konarak — Stall Audit</div>
      </div>

      <div id="vCounter" style="text-align:center;margin-top:100px;">
        <div id="vCounterMain" style="font-size:84px;font-weight:900;">${escapeHTML(meta.counter)}</div>
        <div id="vCounterSub" style="margin-top:10px;font-size:40px;opacity:0.95;">${escapeHTML(meta.building)} — Floor ${escapeHTML(meta.floor)}</div>
      </div>

      <div id="vScoreBlock" style="text-align:center;margin-top:120px;">
        <div id="vStars" style="display:inline-block"></div>
        <div style="margin-top:30px;font-size:70px;font-weight:900;">${meta.score} / 120</div>
        <div style="margin-top:14px;font-size:40px;opacity:0.95;">${meta.percentage.toFixed(1)}% — ${meta.rating.toFixed(1)} / 5</div>
      </div>

      <!-- QR placeholder (will be replaced by QRCodeStyling canvas) -->
      <div id="qrHolder" style="position:absolute;left:0;right:0;text-align:center;bottom:340px;"></div>

      <!-- SEAL -->
      <div id="sealHolder" style="position:absolute;left:0;right:0;text-align:center;bottom:80px;">
        <img src="seel.png" style="height:240px;display:inline-block" onerror="this.style.display='none'">
      </div>
    `;

    renderArea.appendChild(card);

    // draw stars
    const vStars = card.querySelector('#vStars');
    const full = Math.floor(meta.rating);
    const half = (meta.rating - full) >= 0.5;
    for(let i=0;i<5;i++){
      const s = document.createElement('span');
      s.style.fontSize = '70px';
      s.style.margin = '6px';
      if(i < full){
        s.textContent = '★'; s.style.color = 'gold';
      } else if(i === full && half){
        s.textContent = '★'; s.style.color = 'gold'; s.style.opacity = '0.6';
      } else {
        s.textContent = '☆'; s.style.color = 'rgba(255,255,255,0.32)';
      }
      vStars.appendChild(s);
    }

    // Build QR text using the approved content mapping
    const qrText = buildQRText(meta, values);

    // Create QRCodeStyling instance (gold frame + black modules)
    const qrSize = 220; // pixel size
    // qr library class defined in PART 2: QRCodeStyling
    let qrRendered = false;
    const qr = new QRCodeStyling({
      width: qrSize,
      height: qrSize,
      data: qrText,
      margin: 6,
      backgroundOptions: { color: "#ffffff" }, // white background for QR canvas
      qrOptions: { errorCorrectionLevel: "H" },
      frame: { color: "#d4af37", width: 18 }, // gold frame
      onRendered: () => { qrRendered = true; } // callback from our lightweight class
    });

    // Append QR canvas into holder
    const holder = card.querySelector('#qrHolder');
    qr.append(holder);

    // Wait for any images to load (logo, seal)
    await waitForImages(card);

    // Wait for QR to render (synchronous-ish in our simple implementation, but ensure)
    const qrWaitStart = Date.now();
    while(!qrRendered && (Date.now() - qrWaitStart) < 3000){
      // small pause
      await new Promise(res => setTimeout(res, 50));
    }
    // slight extra wait to guarantee visual readiness
    await new Promise(res => setTimeout(res, 50));

    // Now export using html2canvas targeting the card element we added (renderArea.firstChild)
    try {
      const target = renderArea.firstChild;
      const options = { backgroundColor: null, scale: 2, useCORS: true, logging: false };
      const canvas = await html2canvas(target, options);

      canvas.toBlob(function(blob){
        if(!blob){
          alert('Export failed (no blob returned).');
          return;
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `konarak_rating_${safeFilename(meta.counter)}_${meta.date}.png`;
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ a.remove(); URL.revokeObjectURL(url); }, 900);
      }, 'image/png', 1.0);
    } catch(err){
      console.error('Export error', err);
      alert('Error generating image: ' + (err && err.message ? err.message : err));
    } finally {
      // clear render area to avoid memory accumulation
      renderArea.innerHTML = "";
    }
  }

  /* Wire the Generate button to Variant B export */
  if(btnDownload){
    btnDownload.addEventListener('click', async (e) => {
      e.preventDefault();
      // Ensure current selections are considered
      computeAndRenderScore();
      await buildVariantBAndExport();
    });
  }

  /* Wire other UI controls (if not already wired) */
  if(btnSaveLocal && !btnSaveLocal.onclick) btnSaveLocal.onclick = saveEntryLocal;
  if(btnLoadLocal && !btnLoadLocal.onclick) btnLoadLocal.onclick = loadEntriesToUI;
  if(btnClearLocal && !btnClearLocal.onclick) btnClearLocal.onclick = clearLocalEntries;
  if(btnReset && !btnReset.onclick) btnReset.onclick = () => {
    buildingEl.value=''; floorEl.value=''; counterEl.value=''; dateEl.value=(new Date()).toISOString().slice(0,10);
    document.querySelectorAll('.form-control').forEach(s=>s.value='Yes');
    computeAndRenderScore();
  };

  // Final initialization in case DOMContentLoaded already fired (re-attach in that case)
  document.addEventListener('DOMContentLoaded', () => {
    // render questions and initial values if not already done
    try { if(!questionsGrid || !questionsGrid.children.length) renderQuestionCards(); } catch(e){/*ignore*/ }
    try { computeAndRenderScore(); } catch(e){/*ignore*/ }
    try { loadEntriesToUI(); } catch(e){/*ignore*/ }
  });

})();
</script>

</body>
</html>
