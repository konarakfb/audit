<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Konarak — Stall Audit (Upgraded)</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg: linear-gradient(135deg,#eef2f3,#d9e4f5);
  --card:#fff;
  --muted:#6b7280;
  --accent:#0b1220;
  --primary:#165cff;
  --gold:#d4af37;
  --shadow: 0 12px 32px rgba(8,14,30,0.08);
  --glass: rgba(255,255,255,0.72);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:Inter, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background:var(--bg);color:var(--accent);-webkit-font-smoothing:antialiased;
}

/* Header */
.header{height:64px;background:#0b1220;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 20px;position:sticky;top:0;z-index:50;box-shadow:0 8px 30px rgba(2,6,23,0.18)}
.brand{display:flex;align-items:center;gap:12px;font-weight:700}
.brand img{height:36px;width:36px;border-radius:8px;background:#fff;padding:4px;object-fit:contain}
.header .controls{display:flex;gap:8px;align-items:center}

/* Layout */
.container{max-width:1200px;margin:28px auto;padding:0 18px}
.location-card{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.location-card label{font-size:12px;color:var(--muted)}
.location-card input{padding:8px 10px;border-radius:8px;border:1px solid #e6eefc;background:#fbfdff;min-width:140px}

/* Buttons */
.btn{background:linear-gradient(180deg,var(--primary),#1348d9);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,18,32,0.06)}
.small{padding:8px 10px;font-size:13px}

/* Cards and grid */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-top:16px}
.qcard{background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,255,0.95));border-radius:12px;padding:14px;box-shadow:0 12px 30px rgba(9,20,36,0.06)}
.qcard .label{font-weight:700}

/* Summary */
.summary-panel{display:flex;gap:12px;align-items:center;background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);margin-top:16px;flex-wrap:wrap}
.summary-item{text-align:center;padding:6px 10px}
.summary-item .num{font-weight:800;font-size:18px}
.rating-stars{display:flex;gap:6px;align-items:center}

/* small chart */
.card{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow)}

/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(3,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:120}
.modal{background:var(--card);padding:18px;border-radius:12px;width:92%;max-width:760px;box-shadow:0 20px 60px rgba(2,6,23,0.28)}

/* toasts */
.toast-wrap{position:fixed;right:18px;bottom:18px;z-index:140;display:flex;flex-direction:column;gap:8px}
.toast{background:#0b1220;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 8px 20px rgba(2,6,23,0.24)}

/* render area (on-screen, invisible but painted) */
#renderArea{position:fixed;top:0;left:0;width:1920px;height:1080px;opacity:0;pointer-events:none;z-index:-1}

/* loaders */
.loader{display:inline-block;border-radius:50%;width:18px;height:18px;border:3px solid rgba(255,255,255,0.2);border-top-color:rgba(255,255,255,0.9);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* responsive */
@media(max-width:900px){
  .location-card{flex-direction:column;align-items:flex-start}
  .summary-panel{flex-direction:column;align-items:flex-start}
  #renderArea{width:1080px;height:1920px}
}
</style>
</head>
<body>

<div class="header" role="banner">
  <div class="brand" role="img" aria-label="Konarak logo">
    <img src="logo.png" alt="Konarak">
    Konarak Food & Beverages — Stall Audit
  </div>
  <div class="controls" role="navigation">
    <button id="btnExportImage" class="btn small" title="Export image (Ctrl/Cmd+E)">Export PNG</button>
    <button id="btnExportPDF" class="btn small ghost" title="Export PDF">Export PDF</button>
    <button id="btnExportCSV" class="btn small ghost" title="Export CSV">Export CSV</button>
  </div>
</div>

<main class="container" role="main">
  <section class="location-card" aria-label="Audit details">
    <div>
      <label for="building">Building</label><br>
      <input id="building" aria-label="Building" placeholder="e.g., SKYVIEW 1">
    </div>
    <div>
      <label for="floor">Floor</label><br>
      <input id="floor" aria-label="Floor" placeholder="e.g., G,1,2">
    </div>
    <div>
      <label for="counter">Counter / Stall</label><br>
      <input id="counter" aria-label="Counter" placeholder="e.g., S2">
    </div>
    <div>
      <label for="date">Date</label><br>
      <input id="date" type="date" aria-label="Date">
    </div>
    <div style="margin-left:auto">
      <button id="btnReset" class="btn ghost small" aria-label="Reset form">Reset</button>
    </div>
  </section>

  <section id="questionsSection" aria-label="Audit questions">
    <div class="grid" id="questionsGrid" role="list"></div>
  </section>

  <section class="summary-panel" aria-label="Summary">
    <div>
      <div style="font-size:12px;color:var(--muted)">Total Score</div>
      <div class="summary-item"><div class="num" id="totalScore">0 / 120</div></div>
    </div>
    <div>
      <div style="font-size:12px;color:var(--muted)">Percentage</div>
      <div class="summary-item"><div class="num" id="percentageDisplay">0.0%</div></div>
    </div>
    <div>
      <div style="font-size:12px;color:var(--muted)">Rating</div>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="rating-stars" id="ratingStars" aria-hidden="true"></div>
        <div id="ratingValue" style="font-weight:700">0.0 / 5</div>
      </div>
    </div>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <button id="btnCopyScore" class="btn small ghost" title="Copy score to clipboard">Copy</button>
      <button id="btnGenerate" class="btn small" aria-label="Generate and download card">Generate</button>
    </div>
  </section>

  <section style="display:flex;gap:18px;margin-top:18px;flex-wrap:wrap">
    <div style="flex:1;min-width:320px" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Recent Scores</strong>
        <small style="color:var(--muted)">Last 10</small>
      </div>
      <canvas id="miniChart" height="80" aria-label="Recent scores chart"></canvas>
    </div>

    <div style="width:320px" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Actions</strong>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button id="btnSaveLocal" class="btn" aria-label="Save entry locally">Save Entry</button>
        <button id="btnLoadLocal" class="btn ghost" aria-label="Load entries">Load Entries</button>
        <button id="btnClearLocal" class="btn ghost" aria-label="Clear local entries">Clear Entries</button>
      </div>
    </div>
  </section>

  <section style="margin-top:20px" class="card" aria-label="Saved entries">
    <strong>Saved Entries</strong>
    <div style="margin-top:12px;overflow:auto">
      <table id="entriesTable" style="width:100%;border-collapse:collapse">
        <thead><tr style="text-align:left"><th>Date</th><th>Building</th><th>Floor</th><th>Counter</th><th>Score</th><th>Percentage</th><th>Rating</th><th>Actions</th></tr></thead>
        <tbody id="entriesBody"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Modal -->
<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document" aria-label="Export options">
    <h3>Export: Choose format</h3>
    <p style="color:var(--muted)">Choose PNG or PDF. While exporting, please wait.</p>
    <div style="display:flex;gap:10px;margin-top:12px">
      <button id="modalPNG" class="btn">Export PNG</button>
      <button id="modalPDF" class="btn ghost">Export PDF</button>
      <button id="modalCancel" class="btn ghost">Cancel</button>
    </div>
  </div>
</div>

<!-- Render area (visible to browser paint) -->
<div id="renderArea" aria-hidden="true"></div>

<!-- Toasts -->
<div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

<script>
/* ========== Upgraded Konarak Audit Single File ========== */
/* Features:
   - 12 questions × 10 marks = 120
   - Percentage + rating (0–5) with gold stars
   - PNG + PDF export (html2canvas + jsPDF)
   - Accessible (ARIA), keyboard shortcut Ctrl/Cmd+E
   - Toasts, loader, disabled-state during export
   - Robust event wiring (DOMContentLoaded)
*/

(() => {
  const QUESTIONS = [
    { key: 'sales_report', text: 'Daily sales report submitted?' },
    { key: 'feedback_report', text: 'Daily feedback report submitted?' },
    { key: 'breakfast_on_time', text: 'Breakfast arranged on time (08:00)?' },
    { key: 'lunch_on_time', text: 'Lunch arranged on time (12:30)?' },
    { key: 'dinner_on_time', text: 'Dinner arranged on time (20:00)?' },
    { key: 'temp_photo', text: 'Food temperature measured & photo posted?' },
    { key: 'staff_behaviour', text: 'Staff behaviour is good?' },
    { key: 'staff_hygiene', text: 'Staff hygiene is good?' },
    { key: 'stall_clean', text: 'Stall is clean and hygienic?' },
    { key: 'food_complaint', text: 'Food quality complaints received?', negative:true },
    { key: 'cbre_complaint', text: 'CBRE complaint received?', negative:true },
    { key: 'cognizant_complaint', text: 'Cognizant complaint received?', negative:true }
  ];
  const STORAGE_KEY = 'konarak_audit_entries_v1';

  // DOM refs (set on DOMContentLoaded)
  let questionsGrid, totalScoreEl, percentageDisplayEl, ratingStarsEl, ratingValueEl;
  let dateEl, buildingEl, floorEl, counterEl;
  let btnSaveLocal, btnLoadLocal, btnClearLocal, btnExportCSV, btnExportImage, btnExportPDF, btnGenerate, btnCopyScore, btnReset;
  let entriesBody, miniChart = null, renderArea, modalBackdrop, modalPNG, modalPDF, modalCancel, toastWrap;

  function escapeHTML(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function toast(message, timeout=3000){ const wrap = toastWrap || document.getElementById('toastWrap'); const t = document.createElement('div'); t.className='toast'; t.textContent = message; wrap.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; setTimeout(()=>t.remove(),400); }, timeout); }

  function waitForImages(container){
    const imgs = Array.from(container.querySelectorAll('img'));
    return Promise.all(imgs.map(img => new Promise(resolve => { if(img.complete) return resolve(); img.onload = () => resolve(); img.onerror = () => resolve(); })));
  }

  function safeFilename(s){ return (s||'counter').replace(/[^\w\-_\.]/g,'_').slice(0,64); }

  /* Render questions */
  function renderQuestionCards(){
    questionsGrid.innerHTML = '';
    QUESTIONS.forEach(q=>{
      const wrapper = document.createElement('div'); wrapper.className='qcard'; wrapper.setAttribute('role','listitem');
      wrapper.innerHTML = `<div class="label">${escapeHTML(q.text)}</div>
        <div style="margin-top:8px"><select class="form-control" data-key="${q.key}" aria-label="${escapeHTML(q.text)}"><option>Yes</option><option>No</option></select></div>
        <div style="margin-top:8px;font-size:12px;color:var(--muted)">${q.negative? 'Note: complaint (Yes) reduces score.' : ''}</div>`;
      questionsGrid.appendChild(wrapper);
    });
    document.querySelectorAll('.form-control').forEach(el => el.addEventListener('change', computeAndRenderScore));
  }

  /* Scoring */
  function computeAndRenderScore(){
    const values = {};
    QUESTIONS.forEach(q=>{
      const sel = document.querySelector(`select[data-key="${q.key}"]`);
      values[q.key] = sel ? sel.value : 'No';
    });

    let total = 0;
    QUESTIONS.forEach(q=>{
      const ans = (values[q.key]||'').toUpperCase();
      if(q.negative) total += (ans === 'NO' ? 10 : 0);
      else total += (ans === 'YES' ? 10 : 0);
    });

    const maxScore = QUESTIONS.length * 10; // 120
    const percentage = (total / maxScore) * 100;
    const rawRating = (percentage / 100) * 5;
    const ratingRounded = Math.round(rawRating * 10) / 10;

    totalScoreEl.textContent = `${total} / ${maxScore}`;
    percentageDisplayEl.textContent = `${percentage.toFixed(1)}%`;
    ratingValueEl.textContent = `${ratingRounded.toFixed(1)} / 5`;
    renderStars(rawRating);
    return { total, percentage, rating: rawRating, values };
  }

  function renderStars(rawRating){
    ratingStarsEl.innerHTML = '';
    const full = Math.floor(rawRating); const half = (rawRating - full) >= 0.5;
    for(let i=0;i<5;i++){
      const s = document.createElement('span'); s.style.fontSize='20px'; s.style.marginRight='6px';
      if(i < full){ s.textContent='★'; s.style.color='var(--gold)'; }
      else if(i === full && half){ s.textContent='★'; s.style.color='var(--gold)'; s.style.opacity='0.6'; }
      else { s.textContent='☆'; s.style.color='#ddd'; }
      ratingStarsEl.appendChild(s);
    }
  }

  /* Chart */
  function renderMiniChart(){
    const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    const last10 = arr.slice(-10);
    const labels = last10.map(r=>r.date || '');
    const data = last10.map(r=>r.total || 0);
    const ctx = document.getElementById('miniChart').getContext('2d');
    if(miniChart) miniChart.destroy();
    miniChart = new Chart(ctx, {
      type:'line',
      data: { labels, datasets: [{ label:'Score', data, borderWidth:2, pointRadius:4, tension:0.25 }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ min:0, max:QUESTIONS.length*10 }, x:{ display:true } } }
    });
  }

  /* Local storage */
  function saveEntryLocal(){
    const { total, percentage, rating, values } = computeAndRenderScore();
    const entry = { id: 'e_'+Date.now(), building:buildingEl.value.trim(), floor:floorEl.value.trim(), counter:counterEl.value.trim(), date:dateEl.value, timestamp:new Date().toISOString(), answers:values, total, percentage, rating };
    const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    arr.push(entry);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    loadEntriesToUI();
    toast('Saved locally');
  }

  function loadEntriesToUI(){
    const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    entriesBody.innerHTML = '';
    arr.slice().reverse().forEach(e=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${e.date}</td><td>${escapeHTML(e.building)}</td><td>${escapeHTML(e.floor)}</td><td>${escapeHTML(e.counter)}</td><td>${e.total}</td><td>${(e.percentage||0).toFixed(1)}%</td><td>${(Math.round((e.rating||0)*10)/10).toFixed(1)} / 5</td>
        <td>
          <button class="btn small ghost" data-load="${e.id}">Load</button>
          <button class="btn small ghost" data-del="${e.id}">Delete</button>
        </td>`;
      entriesBody.appendChild(tr);
    });

    // attach inline handlers (delegation would be fine; this is straightforward)
    entriesBody.querySelectorAll('[data-load]').forEach(b=>b.addEventListener('click', (ev)=>{ loadEntry(ev.target.getAttribute('data-load')); }));
    entriesBody.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click', (ev)=>{ deleteEntry(ev.target.getAttribute('data-del')); }));

    renderMiniChart();
  }

  function loadEntry(id){
    const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    const e = arr.find(x=>x.id===id);
    if(!e) return toast('Entry not found',3000);
    buildingEl.value = e.building; floorEl.value = e.floor; counterEl.value = e.counter; dateEl.value = e.date;
    Object.keys(e.answers || {}).forEach(k=>{ const sel = document.querySelector(`select[data-key="${k}"]`); if(sel) sel.value = e.answers[k]; });
    computeAndRenderScore();
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function deleteEntry(id){
    if(!confirm('Delete this entry?')) return;
    let arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    arr = arr.filter(x=>x.id !== id);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    loadEntriesToUI();
    toast('Deleted');
  }

  function clearLocalEntries(){
    if(!confirm('Clear all saved entries locally?')) return;
    localStorage.removeItem(STORAGE_KEY);
    loadEntriesToUI();
    toast('Cleared local entries');
  }

  /* CSV export */
  function exportCSV(){
    const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    if(!arr.length) return toast('No data');
    const headers = ['id','date','building','floor','counter','total','percentage','rating','timestamp'];
    const lines = [headers.join(',')];
    arr.forEach(r=>lines.push(headers.map(h=>JSON.stringify(r[h] ?? '')).join(',')));
    const blob = new Blob([lines.join('\n')],{type:'text/csv'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download='konarak_audit.csv'; document.body.appendChild(a); a.click(); setTimeout(()=>{ a.remove(); URL.revokeObjectURL(url); },700);
    toast('CSV exported');
  }

  /* Reset */
  function resetForm(){
    buildingEl.value=''; floorEl.value=''; counterEl.value=''; dateEl.value = new Date().toISOString().slice(0,10);
    document.querySelectorAll('.form-control').forEach(s=>s.value='Yes'); computeAndRenderScore();
    toast('Form reset');
  }

  /* Compose remarks */
  function composeAnswers(values){
    if(!values) return '';
    return QUESTIONS.map(q=>`${q.text.replace('?','')}: ${values[q.key]}`).join(' • ');
  }

  /* Export pipeline */
  async function prepareRenderContent(width, height, values){
    // Build a single child inside renderArea with consistent size
    renderArea.style.width = width + 'px'; renderArea.style.height = height + 'px';
    renderArea.innerHTML = '';

    // minimal clean card for export (styles inline for consistent render)
    const card = document.createElement('div');
    card.style.width = (width - 20) + 'px';
    card.style.height = (height - 20) + 'px';
    card.style.margin = '10px auto';
    card.style.padding = '28px';
    card.style.boxSizing = 'border-box';
    card.style.background = '#fff';
    card.style.borderRadius = '14px';
    card.style.color = '#0b1220';
    // Title + details
    card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><img src="logo.png" style="height:80px" onerror="this.style.display='none'"></div>
      <div style="text-align:right"><div style="font-size:28px;font-weight:800">Stall Audit Rating</div><div style="color:#6b7280">Konarak Food & Beverages</div></div>
    </div>
    <div style="margin-top:28px;display:flex;gap:20px">
      <div style="flex:1">
        <div style="font-size:18px">Counter: <strong style="font-size:22px">${escapeHTML(values.counter || '—')}</strong></div>
        <div style="margin-top:12px;color:#475569">Building: <strong>${escapeHTML(values.building||'—')}</strong> • Floor: <strong>${escapeHTML(values.floor||'—')}</strong> • Date: <strong>${escapeHTML(values.date||'—')}</strong></div>
        <div style="margin-top:18px;padding:12px;border-radius:8px;background:#fbfbfb">${escapeHTML(composeAnswers(values.answers || {}))}</div>
      </div>
      <div style="width:300px;text-align:center">
        <div style="font-size:14px;color:#6b7280">Score</div>
        <div style="font-size:48px;font-weight:900;margin-top:6px">${values.total} / 120</div>
        <div style="margin-top:8px">${(values.percentage||0).toFixed(1)}%</div>
        <div id="exportStars" style="margin-top:12px"></div>
        <div style="margin-top:8px;color:#6b7280">${(values.rating||0).toFixed(1)} / 5</div>
      </div>
    </div>`;
    renderArea.appendChild(card);

    // draw stars
    const st = card.querySelector('#exportStars');
    const full = Math.floor(values.rating || 0); const half = ((values.rating||0) - full) >= 0.5;
    for(let i=0;i<5;i++){
      const sp=document.createElement('span'); sp.style.fontSize='28px'; sp.style.margin='2px';
      if(i<full){ sp.textContent='★'; sp.style.color='gold'; }
      else if(i===full && half){ sp.textContent='★'; sp.style.color='gold'; sp.style.opacity='0.6'; }
      else { sp.textContent='☆'; sp.style.color='#ddd'; }
      st.appendChild(sp);
    }
    await waitForImages(renderArea);
    return renderArea.firstChild;
  }

  async function exportPNG(values){
    try{
      disableExportButtons(true);
      const node = await prepareRenderContent(1920,1080,values);
      if(!node){ toast('Render failed'); return; }
      const canvas = await html2canvas(node, { backgroundColor: null, scale: 2, useCORS: true });
      canvas.toBlob((blob)=>{
        if(!blob){ toast('Export failed'); disableExportButtons(false); return; }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `konarak_rating_${safeFilename(values.counter)}_${values.date}.png`;
        document.body.appendChild(a); a.click(); setTimeout(()=>{ a.remove(); URL.revokeObjectURL(url); disableExportButtons(false); toast('PNG exported'); },800);
      }, 'image/png', 1.0);
    } catch(err){ console.error(err); toast('PNG export error'); disableExportButtons(false); }
  }

  async function exportPDF(values){
    try{
      disableExportButtons(true);
      const node = await prepareRenderContent(1920,1080,values);
      if(!node){ toast('Render failed'); disableExportButtons(false); return; }
      const canvas = await html2canvas(node, { backgroundColor: '#ffffff', scale: 2, useCORS: true });
      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: [canvas.width, canvas.height] });
      pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height);
      const fileName = `konarak_rating_${safeFilename(values.counter)}_${values.date}.pdf`;
      pdf.save(fileName);
      disableExportButtons(false);
      toast('PDF exported');
    } catch(err){ console.error(err); toast('PDF export error'); disableExportButtons(false); }
  }

  function disableExportButtons(state){
    [btnExportImage, btnExportPDF, btnGenerate, modalPNG, modalPDF].forEach(b=>{ if(b) b.disabled = !!state; });
    if(state) {
      // show modal loader if any
    }
  }

  /* Keyboard shortcuts */
  function handleShortcuts(e){
    const isMac = navigator.platform.toUpperCase().indexOf('MAC')>=0;
    const mod = isMac ? e.metaKey : e.ctrlKey;
    if(mod && (e.key === 'e' || e.key === 'E')){
      e.preventDefault(); openModal();
    }
    if(mod && (e.key === 's' || e.key === 'S')){ // quick save
      e.preventDefault(); saveEntryLocal();
    }
  }

  /* Modal */
  function openModal(){ if(modalBackdrop){ modalBackdrop.style.display='flex'; modalBackdrop.setAttribute('aria-hidden','false'); } }
  function closeModal(){ if(modalBackdrop){ modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); } }

  /* Copy score */
  function copyScore(){
    const txt = totalScoreEl.textContent + ' — ' + percentageDisplayEl.textContent + ' — ' + ratingValueEl.textContent;
    navigator.clipboard?.writeText(txt).then(()=>toast('Score copied')).catch(()=>toast('Copy failed'));
  }

  /* Generate (default behavior) */
  async function generateDefault(){
    const vals = computeAndRenderScore();
    // build full meta
    const meta = {
      building: buildingEl.value || '—',
      floor: floorEl.value || '—',
      counter: counterEl.value || '—',
      date: dateEl.value || new Date().toISOString().slice(0,10),
      total: vals.total, percentage: vals.percentage, rating: Math.round(vals.rating*10)/10, answers: vals.values
    };
    // default: open modal to choose format
    openModal();
    // attach immediate handlers when modal buttons clicked (modal handlers defined on DOMContentLoaded)
  }

  /* Initialization wiring */
  document.addEventListener('DOMContentLoaded', () => {
    // refs
    questionsGrid = document.getElementById('questionsGrid');
    totalScoreEl = document.getElementById('totalScore');
    percentageDisplayEl = document.getElementById('percentageDisplay');
    ratingStarsEl = document.getElementById('ratingStars');
    ratingValueEl = document.getElementById('ratingValue');

    dateEl = document.getElementById('date'); buildingEl = document.getElementById('building'); floorEl = document.getElementById('floor'); counterEl = document.getElementById('counter');

    btnSaveLocal = document.getElementById('btnSaveLocal'); btnLoadLocal = document.getElementById('btnLoadLocal'); btnClearLocal = document.getElementById('btnClearLocal');
    btnExportCSV = document.getElementById('btnExportCSV'); btnExportImage = document.getElementById('btnExportImage'); btnExportPDF = document.getElementById('btnExportPDF');
    btnGenerate = document.getElementById('btnGenerate'); btnCopyScore = document.getElementById('btnCopyScore'); btnReset = document.getElementById('btnReset');

    entriesBody = document.getElementById('entriesBody'); renderArea = document.getElementById('renderArea');
    modalBackdrop = document.getElementById('modalBackdrop'); modalPNG = document.getElementById('modalPNG'); modalPDF = document.getElementById('modalPDF'); modalCancel = document.getElementById('modalCancel');
    toastWrap = document.getElementById('toastWrap');

    // render and defaults
    renderQuestionCards(); document.querySelectorAll('.form-control').forEach(s=>s.value='Yes');
    dateEl.value = new Date().toISOString().slice(0,10);
    computeAndRenderScore();
    loadEntriesToUI();
    renderMiniChart();

    // event bindings
    if(btnSaveLocal) btnSaveLocal.addEventListener('click', saveEntryLocal);
    if(btnLoadLocal) btnLoadLocal.addEventListener('click', loadEntriesToUI);
    if(btnClearLocal) btnClearLocal.addEventListener('click', clearLocalEntries);
    if(btnExportCSV) btnExportCSV.addEventListener('click', exportCSV);
    if(btnExportImage) btnExportImage.addEventListener('click', ()=> {
      const vals = computeAndRenderScore();
      openModal();
    });
    if(btnExportPDF) btnExportPDF.addEventListener('click', ()=> { const vals = computeAndRenderScore(); openModal(); });

    if(btnGenerate) btnGenerate.addEventListener('click', generateDefault);
    if(btnCopyScore) btnCopyScore.addEventListener('click', copyScore);
    if(btnReset) btnReset.addEventListener('click', resetForm);

    // modal handlers
    if(modalPNG) modalPNG.addEventListener('click', async ()=> {
      const vals = computeAndRenderScore();
      const meta = { building: buildingEl.value, floor: floorEl.value, counter: counterEl.value, date: dateEl.value, total: vals.total, percentage: vals.percentage, rating: Math.round(vals.rating*10)/10, answers: vals.values };
      closeModal(); disableExportButtons(true);
      await exportPNG(meta);
      disableExportButtons(false);
    });
    if(modalPDF) modalPDF.addEventListener('click', async ()=> {
      const vals = computeAndRenderScore();
      const meta = { building: buildingEl.value, floor: floorEl.value, counter: counterEl.value, date: dateEl.value, total: vals.total, percentage: vals.percentage, rating: Math.round(vals.rating*10)/10, answers: vals.values };
      closeModal(); disableExportButtons(true);
      await exportPDF(meta);
      disableExportButtons(false);
    });
    if(modalCancel) modalCancel.addEventListener('click', ()=> closeModal());

    // keyboard
    document.addEventListener('keydown', handleShortcuts);

    // small accessibility helper: press Escape closes modal
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    // attach global listeners for focus/tooltip if needed
    toast('Ready — press Ctrl/Cmd+E to export');

  });

  // refresh chart periodically
  setInterval(()=>{ try{ renderMiniChart(); }catch(e){} }, 6000);

})(); // IIFE end
</script>
</body>
</html>
